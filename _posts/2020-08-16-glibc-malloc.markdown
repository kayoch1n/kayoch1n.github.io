---
layout: post
title:  "glibc å †å†…å­˜åˆ†é…å­¦ä¹ ç¬”è®°"
date:   2020-08-15 12:15:38 +0800
diary: "å‰æ®µæ—¶é—´é¡¹ç›®ç»„æ¢äº†ä¸€ä¸ªæ–°æ¥çš„äº§å“ç»ç†;è¿™ä½å¤§ä½¬è¿˜æœªç†Ÿæ‚‰äº§å“ï¼Œåˆ«äººé—®åˆ°å•¥é—®é¢˜éƒ½è¦æ‰¾æµ‹è¯•å›ç­”ï¼Œè¿å®¢æˆ·æ¼”ç¤ºã€é”€å”®ä¹‹ç±»çš„é—®é¢˜éƒ½è¦æ¥æ‰¾æµ‹è¯•ï¼Œæ™•ğŸ˜µï¼Œåˆ°åº•æˆ‘æ˜¯äº§å“è¿˜æ˜¯ä½ æ˜¯äº§å“ï¼Ÿ"
---

# Preface

è®°å½•ä¸€ä¸‹å­¦ä¹ glibcçš„å †å†…å­˜åˆ†é…å‡½æ•°[void *_int_malloc(mstate av, size_t bytes)](https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#_int_malloc)çš„å­¦ä¹ è¿‡ç¨‹ï¼Œä»¥ä¸‹è¡Œæ–‡å†…å®¹éƒ½æ˜¯åŸºäº **x86_64** æ“ä½œç³»ç»Ÿï¼Œæš‚ä¸è€ƒè™‘tcacheã€‚

# Content

## Data structure

æ¯ä¸ªå †éƒ½å­˜åœ¨ä¸€ä¸ª `malloc_state` ç»“æ„ï¼›ä¸»çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªå †å¯¹åº”çš„ `malloc_state` ç»“æ„åˆç§°ä¸º `main_arena`ã€‚åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼š

### CHUNKS and BINS

glibc ç®¡ç†åŠ¨æ€å†…å­˜çš„æœ€å°å•ä½æ˜¯CHUNKï¼Œå…¶å¤§å°æŒ‰ç…§**16å­—èŠ‚**å¯¹é½(`MALLOC_ALIGNMENT`)ï¼Œæœ€å°çš„CHUNKå¤§å°ä¸º32å­—èŠ‚(`MINSIZE`)ã€‚CHUNKçš„ç»„æˆç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹æ˜¯ä¸¤ä¸ªæŒ‡é’ˆ`fd`å’Œ`bk`: åœ¨ CHUNK ç©ºé—²æ—¶ï¼Œè¿™ä¸€/ä¸¤ä¸ªå˜é‡èƒ½å¤Ÿä¸º CHUNK ç»„æˆå•å‘/åŒå‘é“¾è¡¨ï¼Œåœ¨ CHUNK è¢«å ç”¨æ—¶åˆèƒ½å­˜å‚¨ç”¨æˆ·æ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–çš„ç»†èŠ‚å¯å‚è§[CTF wiki](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/heap_structure-zh/#malloc_chunk)ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°:
```
chunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of previous chunk, if unallocated (P clear)  |
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of chunk, in bytes                     |A|M|P|
  mem-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             User data starts here...                          .
        .                                                               .
        .             (malloc_usable_size() bytes)                      .
next    .                                                               |
chunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             (size of chunk, but used for application data)    |
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of next chunk, in bytes                |A|0|1|
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

`free()`é‡Šæ”¾åçš„CHUNKä¸ä¼šç›´æ¥è¿”å›ç»™æ“ä½œç³»ç»Ÿ;glibc ä½¿ç”¨é“¾è¡¨æ¥ç®¡ç†CHUNKï¼Œè¿™äº›é“¾è¡¨ç§°ä¸º BINSã€‚BINSåˆ†ä¸ºå››ç±»ï¼Œå…¶ä¸­ UNSORTED, SMALL & LARGE BINS ä½¿ç”¨æ•°ç»„`malloc_state::bins`å­˜æ”¾åœ¨ä¸€èµ·ï¼Œè€ŒFAST BINSå•ç‹¬å­˜æ”¾åœ¨`malloc_state::fastbinsY`:

- FAST BINS: 
  - æ¯ä¸ª BIN å†…çš„CHUNKé€šè¿‡`fd`ç»„æˆå•å‘é“¾è¡¨;
  - æ¯ä¸ª BIN é‡‡å–å’Œæ ˆä¸€è‡´ã€åè¿›å…ˆå‡º(LIFO)çš„å­˜å–æ–¹å¼ï¼Œä»å¤´éƒ¨å­˜å…¥/å–å‡º;
  - æŒ‰ç…§CHUNKå¤§å°åˆ†ç±»ï¼Œæœ€å°çš„BINSä¸º32å­—èŠ‚ï¼Œå’Œ `MINSIZE` ä¿æŒä¸€è‡´ï¼Œå¯¹åº”çš„ç´¢å¼•ä¸º0;æœ€å¤§çš„BINSå¤§å°ä¸º160å­—èŠ‚ï¼Œå¯¹åº”çš„ç´¢å¼•ä¸º8;
  - å› æ­¤ä¸€å…±æœ‰9=(160-32)//16+1ç±»ä¸åŒå¤§å°çš„ BINS: 32, 48, 64, ..., 160.
  - å’Œå…¶å®ƒ BINS ä¸åŒï¼ŒFAST BIN å†…çš„ CHUNK ä¸€ç›´å¤„äºå ç”¨çŠ¶æ€ã€‚
- UNSORTED BIN: åªæœ‰ä¸€ä¸ª BIN ï¼Œè€Œä¸”æ˜¯åŒå‘é“¾è¡¨;
- SMALL BINS:
  - æ¯ä¸ª BIN éƒ½æ˜¯åŒå‘é“¾è¡¨;
  - æ¯ä¸ª BIN é‡‡å–å’Œé˜Ÿåˆ—ä¸€è‡´ã€å…ˆè¿›å…ˆå‡º(FIFO)çš„å­˜å–æ–¹å¼ï¼Œä»å¤´éƒ¨æ”¾å…¥ã€ä»å°¾éƒ¨å–å‡º;
  - æŒ‰ç…§CHUNKå¤§å°åˆ†ç±»ï¼Œæœ€å°çš„BINSä¸º32å­—èŠ‚ï¼Œæœ€å¤§ä¸º1008å­—èŠ‚;
  - å› æ­¤ä¸€å…±æœ‰62=(1008-32)//16+1ç±»ä¸åŒå¤§å°çš„ BINS: 32, 48, 64, ..., 1008.
- LARGE BINS:
  - æ¯ä¸ª BIN éƒ½æ˜¯åŒå‘é“¾è¡¨;
  - æ¯ä¸ª BIN é‡‡å–å’Œé˜Ÿåˆ—ä¸€è‡´ã€å…ˆè¿›å…ˆå‡º(FIFO)çš„å­˜å–æ–¹å¼ï¼Œä»å¤´éƒ¨æ”¾å…¥ã€ä»å°¾éƒ¨å–å‡º;
  - åœ¨ `malloc_state::bins` ä¸­é™¤å» UNSORTED å’Œ62ä¸ª SMALL ä»¥å¤–çš„éƒ½æ˜¯ LARGE ;
  - æ¯ä¸ª BIN å†…çš„ CHUNK å¤§å°æ§åˆ¶åœ¨ä¸€å®šçš„å…¬å·®èŒƒå›´å†…ï¼Œä¸è¦æ±‚ä¸¥æ ¼ä¸€è‡´;
  - æ¯ä¸ª BIN å†…çš„ CHUNK é¢å¤–ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆç»„æˆå¦ä¸€ä¸ªåŒé“¾è¡¨ï¼Œåœ¨è¿™ä¸ªé“¾è¡¨å†…æŒ‰ç…§å¤§å°é€’å¢æ’åˆ—;å’ŒBINæœ¬èº«å½¢æˆä¸€ä¸ªè·³è¡¨(skip list);
  - BINSæŒ‰ç…§å…¬å·®åˆ†æˆå…­ç»„ï¼Œ32bitå’Œ64bitç³»ç»Ÿçš„åˆ’åˆ†æ–¹å¼ä¸€è‡´(æ‘˜è‡ªæºç ):
    - 32 bins of size      64
    - 16 bins of size     512
    - 8 bins of size    4096
    - 4 bins of size   32768
    - 2 bins of size  262144
    - 1 bin  of size what's left

### binmap

è¿™æ˜¯ç”¨æ¥æ ‡è®° SMALL/LARGE BINS æ˜¯å¦åŒ…å« CHUNK çš„ä½å›¾æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«4ä¸ª32bitæ•´æ•°çš„æ•°ç»„ï¼›å­˜æ”¾ä½ç½®æ˜¯ `malloc_state::binmap`

## Implementation

### _int_malloc

#### Prototype

```c
static void * _int_malloc(mstate av, size_t bytes)
```

#### Steps

1. å¦‚æœä¼ å…¥çš„avæŒ‡é’ˆä¸ºNULLï¼Œè°ƒç”¨`sysmalloc`å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ -> DONE;
2. å°† sz(ç”¨æˆ·ç”³è¯·çš„å¤§å°) è½¬æ¢ä¸º nb(CHUNKçš„å¤§å°);
3. å¦‚æœ nb < `global_max_fast` (176B):
   1. *EXACT FIT*: ä» FAST BINS ä¸­æ‰¾åˆ°å¤§å°ä¸º nb çš„ BINï¼Œä»**å¤´éƒ¨**å–å‡º -> DONE;
4. å¦‚æœ nb æ˜¯ SMALL ç”³è¯· nb < `MIN_LARGE_SIZE` (1024B):
   1. *EXACT FIT*: ä» SMALL BINS ä¸­æ‰¾åˆ°å¤§å°ä¸º nb çš„ BINï¼Œä»**å°¾éƒ¨**å–å‡ºï¼ŒUNLINK -> DONE;
5. å¦åˆ™è¿™æ˜¯ä¸€ä¸ª LARGE ç”³è¯·ã€‚å…ˆæ‰§è¡Œä¸€æ¬¡ `malloc_consolidate`:
   1. éå†å¹¶æ¸…ç©º FAST å•é“¾è¡¨;
   2. å°è¯•å¯¹ CHUNK å’Œå…¶å‰ä¸€ä¸ªã€åä¸€ä¸ªçš„é TOP ã€ç©ºé—²çš„ CHUNK è¿›è¡Œåˆå¹¶;
   3. æŠŠ CHUNK æ”¾å…¥ UNSORTED;
   4. å¦‚æœæœ‰å‰å CHUNK å› æ­¤è¢«åˆå¹¶ï¼Œè¦å°† CHUNK ä»å¯¹åº”çš„ SMALL/LARGE BINä¸­æ‹†å‡ºï¼Œå³å‘ç”Ÿ `UNLINK`ã€‚
6. æ¥ç€åœ¨ *EXACT FIT* å¤±è´¥ï¼Œæˆ–è€… nb æ˜¯ LARGE ç”³è¯·çš„æƒ…å†µä¸‹ï¼Œ
   1. ä»åå¾€å‰éå† UNSORTED 
      1. *BEST FIT*: å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå°±å¯ä»¥ä» `av->last_remainder` åˆ‡ä¸€å—å‡ºæ¥ -> DONE:
         1. UNSORTED åªæœ‰ä¸€ä¸ª CHUNK ;
         2. è¿™ä¸ª CHUNK åˆšå¥½æ˜¯ `av->last_remainder`;
         3. nb æ˜¯ SMALL ç”³è¯·;
         4. åˆ‡äº†ä¸€å—ä¹‹åå‰©ä½™éƒ¨åˆ†å¤§äº `MINSIZE`(32);
      2. *EXACT FIT*: å¦‚æœ CHUNK å¤§å°åˆšå¥½ç­‰äº nb -> DONE;
      3. å¦åˆ™ï¼ŒæŠŠ CHUNK æŒ‰ç…§å¤§å°æ”¾åˆ°å¯¹åº”çš„ SMALL/LARGE BINSã€‚æŒ‰ç…§æ³¨é‡Šï¼Œè¿™æ˜¯**å”¯ä¸€ä¸€å¤„æŠŠ CHUNK æ”¾å…¥åˆ° SMALL/LARGE BINS çš„ä»£ç **;
      4. åœ¨ä¸€æ¬¡ `_int_malloc` ï¼ˆä¸é™äºä¸€æ¬¡éå† UNSORTEDï¼‰è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šå¾ªç¯ 10000 æ¬¡ç„¶åé€€å‡ºã€‚
   2. *BEST/EXACT FIT*: å¦‚æœè¿™æ˜¯ä¸€ä¸ª LARGE ç”³è¯·ï¼Œå°è¯•ä» LARGE BINS æ‰¾åˆ°æ»¡è¶³ nb çš„æœ€å° CHUNK -> DONE:
      1. å‘ç”Ÿ UNLINK
      2. å¦‚æœ CHUNK å‰©ä¸‹éƒ¨åˆ†çš„é•¿åº¦å¤§äº `MINSIZE`ï¼Œåˆ™å°†å‰©ä¸‹éƒ¨åˆ†æ”¾å…¥ UNSORTED;
   3. *BEST FIT*: åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œnb å¯¹åº”çš„ SMALL/LARGE BIN æ²¡æœ‰ CHUNK äº†ã€‚
      1. å°è¯•ä»nbå¼€å§‹ï¼ŒæŒ‰ç…§å¤§å°é€ä¸ªæ‰«æä½å›¾ binmapï¼ŒæœŸæœ›æ‰¾åˆ°åŒ…å« CHUNK çš„ BIN -> DONE;
      2. å‘ç”Ÿ `UNLINK`;
      3. å¦‚æœ CHUNK å‰©ä¸‹éƒ¨åˆ†çš„é•¿åº¦å¤§äº `MINSIZE`ï¼Œåˆ™å°†å‰©ä¸‹éƒ¨åˆ†æ”¾å…¥ UNSORTED;
      4. å¦‚æœ nb æ˜¯ä¸€ä¸ª SMALL ç”³è¯·ï¼Œè¿˜ä¼šå°†å‰©ä¸‹éƒ¨åˆ†è®¾ä¸º `av->last_remainder`;
   4. å¦‚æœé€ä¸ªæ‰«æä½å›¾ä¹Ÿä¸èƒ½æ‰¾åˆ° CHUNKï¼Œä½† TOP å¯ä»¥æ»¡è¶³ï¼Œåˆ™ä» TOP çš„ä½åœ°å€æ–¹å‘åˆ‡ä¸€å— -> DONE;
   5. å¦‚æœ TOP ä»ä¸èƒ½æ»¡è¶³ä½† FAST ä¸­ä»å­˜åœ¨ CHUNKï¼Œåˆ™å†æ¬¡å‘ç”Ÿ `malloc_consolidate`;
      1. çŒœæµ‹å¯èƒ½æ˜¯è¦ç…§é¡¾å¤šçº¿ç¨‹ç¨‹åºï¼Ÿ
   6. å¦åˆ™ï¼Œä½¿ç”¨ `sysmalloc` å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ -> DONE
7. å›åˆ° 6.

### sysmalloc

To be continued...

### _int_free

To be continued...

# Reference

1. [CTF wiki å †åˆ©ç”¨](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/introduction-zh/)
2. [glibc source malloc.c](https://code.woboq.org/userspace/glibc/malloc/malloc.c.html)